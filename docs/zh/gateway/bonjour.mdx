---
summary: "Bonjour/mDNS发现 + 调试（网关信标、客户端和常见故障模式）"
read_when:
  - 在macOS/iOS上调试Bonjour发现问题时
  - 更改mDNS服务类型、TXT记录或发现UX时
---
# Bonjour / mDNS 发现

OpenClaw 使用 Bonjour（mDNS / DNS‑SD）作为 **仅限局域网（LAN‑only）的便利功能** 来发现
活动的网关（WebSocket endpoint）。它是尽力而为的（best‑effort），**不能** 替代 SSH 或
基于 Tailnet 的连接。

## 广域 Bonjour（Wide‑area Bonjour）（Unicast DNS‑SD）通过 Tailscale

如果节点和网关在不同的网络上，多播 mDNS 不会跨越
边界。您可以通过切换到 **单播 DNS‑SD**
（"广域 Bonjour"）通过 Tailscale 保持相同的发现 UX。

高级步骤：

1) 在网关主机上运行 DNS 服务器（通过 Tailnet 可达）。
2) 在专用区域下为 `_openclaw-gw._tcp` 发布 DNS‑SD 记录
   （示例：`openclaw.internal.`）。
3) 配置 Tailscale **分割 DNS（split DNS）**，以便您选择的域通过该
   DNS 服务器解析客户端（包括 iOS）。

OpenClaw 支持任何发现域；`openclaw.internal.` 只是一个示例。
iOS/Android 节点浏览 `local.` 和您配置的广域域。

### 网关配置（Gateway config）（推荐）

```json5
{
  gateway: { bind: "tailnet" }, // 仅 tailnet（推荐）
  discovery: { wideArea: { enabled: true } } // 启用广域 DNS-SD 发布
}
```

### 一次性 DNS 服务器设置（网关主机）

```bash
openclaw dns setup --apply
```

这将安装 CoreDNS 并配置它以：
- 仅在网关的 Tailscale 接口上监听端口 53
- 从 `~/.openclaw/dns/<domain>.db` 提供您选择的域（示例：`openclaw.internal.`）

从 tailnet 连接的机器验证：

```bash
dns-sd -B _openclaw-gw._tcp openclaw.internal.
dig @<TAILNET_IPV4> -p 53 _openclaw-gw._tcp.openclaw.internal PTR +short
```

### Tailscale DNS 设置

在 Tailscale 管理控制台中：

- 添加一个指向网关 tailnet IP 的名称服务器（nameserver）（UDP/TCP 53）。
- 添加分割 DNS，以便您的发现域使用该名称服务器。

一旦客户端接受 tailnet DNS，iOS 节点可以在
您的发现域中浏览 `_openclaw-gw._tcp`，无需多播。

### 网关监听器安全性（Gateway listener security）（推荐）

网关 WS 端口（默认 `18789`）默认绑定到 loopback。对于 LAN/tailnet
访问，显式绑定并保持认证启用。

对于仅 tailnet 设置：
- 在 `~/.openclaw/openclaw.json` 中设置 `gateway.bind: "tailnet"`。
- 重启网关（或重启 macOS 菜单栏应用）。

## 什么进行广告（What advertises）

只有网关广告 `_openclaw-gw._tcp`。

## 服务类型（Service types）

- `_openclaw-gw._tcp` — 网关传输信标（gateway transport beacon）（由 macOS/iOS/Android 节点使用）。

## TXT 键（TXT keys）（非秘密提示）

网关广告小的非秘密提示以使 UI 流程方便：

- `role=gateway`
- `displayName=<friendly name>`
- `lanHost=<hostname>.local`
- `gatewayPort=<port>`（Gateway WS + HTTP）
- `gatewayTls=1`（仅当启用 TLS 时）
- `gatewayTlsSha256=<sha256>`（仅当启用 TLS 且指纹可用时）
- `canvasPort=<port>`（仅当启用 canvas host 时；默认 `18793`）
- `sshPort=<port>`（未覆盖时默认为 22）
- `transport=gateway`
- `cliPath=<path>`（可选；可运行的 `openclaw` 入口点的绝对路径）
- `tailnetDns=<magicdns>`（当 Tailnet 可用时的可选提示）

## 在 macOS 上调试

有用的内置工具：

- 浏览实例：
  ```bash
  dns-sd -B _openclaw-gw._tcp local.
  ```
- 解析一个实例（替换 `<instance>`）：
  ```bash
  dns-sd -L "<instance>" _openclaw-gw._tcp local.
  ```

如果浏览有效但解析失败，您通常遇到 LAN 策略或
mDNS 解析器问题。

## 在网关日志中调试

网关写入滚动日志文件（在启动时打印为
`gateway log file: ...`）。查找 `bonjour:` 行，特别是：

- `bonjour: advertise failed ...`
- `bonjour: ... name conflict resolved` / `hostname conflict resolved`
- `bonjour: watchdog detected non-announced service ...`

## 在 iOS 节点上调试

iOS 节点使用 `NWBrowser` 发现 `_openclaw-gw._tcp`。

要捕获日志：
- Settings → Gateway → Advanced → **Discovery Debug Logs**
- Settings → Gateway → Advanced → **Discovery Logs** → reproduce → **Copy**

日志包括浏览器状态转换和结果集更改。

## 常见故障模式（Common failure modes）

- **Bonjour 不跨网络**：使用 Tailnet 或 SSH。
- **多播被阻止**：某些 Wi‑Fi 网络禁用 mDNS。
- **睡眠 / 接口流失**：macOS 可能暂时丢失 mDNS 结果；重试。
- **浏览有效但解析失败**：保持机器名称简单（避免表情符号或
  标点符号），然后重启网关。服务实例名称派生自
  主机名，因此过于复杂的名称可能会混淆某些解析器。

## 转义实例名称（Escaped instance names）（`\032`）

Bonjour/DNS‑SD 通常将服务实例名称中的字节转义为十进制 `\DDD`
序列（例如，空格变为 `\032`）。

- 这在协议级别是正常的。
- UI 应解码以进行显示（iOS 使用 `BonjourEscapes.decode`）。

## 禁用 / 配置

- `OPENCLAW_DISABLE_BONJOUR=1` 禁用广告（旧版：`OPENCLAW_DISABLE_BONJOUR`）。
- `~/.openclaw/openclaw.json` 中的 `gateway.bind` 控制网关绑定模式。
- `OPENCLAW_SSH_PORT` 覆盖 TXT 中广告的 SSH 端口（旧版：`OPENCLAW_SSH_PORT`）。
- `OPENCLAW_TAILNET_DNS` 在 TXT 中发布 MagicDNS 提示（旧版：`OPENCLAW_TAILNET_DNS`）。
- `OPENCLAW_CLI_PATH` 覆盖广告的 CLI 路径（旧版：`OPENCLAW_CLI_PATH`）。

## 相关文档（Related docs）

- 发现策略和传输选择：[Discovery](/gateway/discovery)
- 节点配对 + 批准：[Gateway pairing](/gateway/pairing)
