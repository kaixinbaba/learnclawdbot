---
summary: "CLI后端：通过本地AI CLI的纯文本回退"
read_when:
  - 您想要一个可靠的回退，当API提供商失败时
  - 您正在运行Claude Code CLI或其他本地AI CLI并希望重用它们
  - 您需要一个纯文本、无工具的路径，但仍支持会话和图像
---
# CLI 后端（CLI backends）（回退运行时）

OpenClaw 可以运行 **本地 AI CLI** 作为 **纯文本回退（text-only fallback）**，当 API 提供商关闭、
受速率限制或暂时行为不当时。这是故意保守的：

- **工具被禁用**（无工具调用）。
- **文本输入 → 文本输出**（可靠）。
- **支持会话**（因此后续轮次保持连贯）。
- **图像可以传递**，如果 CLI 接受图像路径。

这被设计为 **安全网（safety net）** 而不是主要路径。当您
希望"始终有效"的文本响应而不依赖外部 API 时使用它。

## 初学者友好的快速入门

您可以使用 Claude Code CLI **无需任何配置**（OpenClaw 提供内置默认值）：

```bash
openclaw agent --message "hi" --model claude-cli/opus-4.5
```

Codex CLI 也可以开箱即用：

```bash
openclaw agent --message "hi" --model codex-cli/gpt-5.2-codex
```

如果您的网关在 launchd/systemd 下运行且 PATH 很小，只需添加
命令路径：

```json5
{
  agents: {
    defaults: {
      cliBackends: {
        "claude-cli": {
          command: "/opt/homebrew/bin/claude"
        }
      }
    }
  }
}
```

就是这样。除了 CLI 本身之外，不需要密钥，不需要额外的认证配置。

## 将其用作回退（fallback）

将 CLI 后端添加到回退列表中，以便仅在主要模型失败时运行：

```json5
{
  agents: {
    defaults: {
      model: {
        primary: "anthropic/claude-opus-4-5",
        fallbacks: [
          "claude-cli/opus-4.5"
        ]
      },
      models: {
        "anthropic/claude-opus-4-5": { alias: "Opus" },
        "claude-cli/opus-4.5": {}
      }
    }
  }
}
```

注意事项：
- 如果您使用 `agents.defaults.models`（允许列表），则必须包括 `claude-cli/...`。
- 如果主要提供商失败（认证、速率限制、超时），OpenClaw 将
  接下来尝试 CLI 后端。

## 配置概述

所有 CLI 后端位于：

```
agents.defaults.cliBackends
```

每个条目都由 **provider id** 键入（例如 `claude-cli`、`my-cli`）。
provider id 成为模型引用的左侧：

```
<provider>/<model>
```

### 示例配置

```json5
{
  agents: {
    defaults: {
      cliBackends: {
        "claude-cli": {
          command: "/opt/homebrew/bin/claude"
        },
        "my-cli": {
          command: "my-cli",
          args: ["--json"],
          output: "json",
          input: "arg",
          modelArg: "--model",
          modelAliases: {
            "claude-opus-4-5": "opus",
            "claude-sonnet-4-5": "sonnet"
          },
          sessionArg: "--session",
          sessionMode: "existing",
          sessionIdFields: ["session_id", "conversation_id"],
          systemPromptArg: "--system",
          systemPromptWhen: "first",
          imageArg: "--image",
          imageMode: "repeat",
          serialize: true
        }
      }
    }
  }
}
```

## 它是如何工作的

1) **选择后端**，基于提供商前缀（`claude-cli/...`）。
2) **构建系统提示**，使用相同的 OpenClaw 提示 + 工作区上下文。
3) **执行 CLI**，带有会话 id（如果支持），以便历史保持一致。
4) **解析输出**（JSON 或纯文本）并返回最终文本。
5) **持久化会话 id**，每个后端，以便后续操作重用相同的 CLI 会话。

## 会话（Sessions）

- 如果 CLI 支持会话，设置 `sessionArg`（例如 `--session-id`）或
  `sessionArgs`（占位符 `{sessionId}`），当 ID 需要插入到
  多个标志中时。
- 如果 CLI 使用 **resume 子命令** 具有不同的标志，设置
  `resumeArgs`（在恢复时替换 `args`）和可选的 `resumeOutput`
  （对于非 JSON 恢复）。
- `sessionMode`：
  - `always`：始终发送会话 id（如果没有存储，则为新 UUID）。
  - `existing`：仅在之前存储了会话 id 时发送。
  - `none`：从不发送会话 id。

## 图像（Images）（pass-through）

如果您的 CLI 接受图像路径，设置 `imageArg`：

```json5
imageArg: "--image",
imageMode: "repeat"
```

OpenClaw 将 base64 图像写入临时文件。如果设置了 `imageArg`，这些
路径作为 CLI 参数传递。如果 `imageArg` 缺失，OpenClaw 将文件路径
附加到提示（路径注入），这对于从纯路径自动加载本地文件的 CLI
（Claude Code CLI 行为）来说足够了。

## 输入 / 输出（Inputs / outputs）

- `output: "json"`（默认）尝试解析 JSON 并提取文本 + 会话 id。
- `output: "jsonl"` 解析 JSONL 流（Codex CLI `--json`）并提取
  最后一条代理消息加上 `thread_id`（如果存在）。
- `output: "text"` 将 stdout 视为最终响应。

输入模式：
- `input: "arg"`（默认）将提示作为最后一个 CLI 参数传递。
- `input: "stdin"` 通过 stdin 发送提示。
- 如果提示非常长且设置了 `maxPromptArgChars`，则使用 stdin。

## 默认值（Defaults）（built-in）

OpenClaw 为 `claude-cli` 提供默认值：

- `command: "claude"`
- `args: ["-p", "--output-format", "json", "--dangerously-skip-permissions"]`
- `resumeArgs: ["-p", "--output-format", "json", "--dangerously-skip-permissions", "--resume", "{sessionId}"]`
- `modelArg: "--model"`
- `systemPromptArg: "--append-system-prompt"`
- `sessionArg: "--session-id"`
- `systemPromptWhen: "first"`
- `sessionMode: "always"`

OpenClaw 还为 `codex-cli` 提供默认值：

- `command: "codex"`
- `args: ["exec","--json","--color","never","--sandbox","read-only","--skip-git-repo-check"]`
- `resumeArgs: ["exec","resume","{sessionId}","--color","never","--sandbox","read-only","--skip-git-repo-check"]`
- `output: "jsonl"`
- `resumeOutput: "text"`
- `modelArg: "--model"`
- `imageArg: "--image"`
- `sessionMode: "existing"`

仅在需要时覆盖（常见：绝对 `command` 路径）。

## 限制（Limitations）

- **无 OpenClaw 工具**（CLI 后端从不接收工具调用）。一些 CLI
  可能仍运行自己的代理工具。
- **无流式传输**（CLI 输出被收集然后返回）。
- **结构化输出** 取决于 CLI 的 JSON 格式。
- **Codex CLI 会话** 通过文本输出恢复（无 JSONL），这比
  初始 `--json` 运行更不结构化。OpenClaw 会话仍然正常工作。

## 故障排查（Troubleshooting）

- **CLI 未找到**：将 `command` 设置为完整路径。
- **错误的模型名称**：使用 `modelAliases` 将 `provider/model` 映射到 CLI 模型。
- **无会话连续性**：确保设置了 `sessionArg` 且 `sessionMode` 不是
  `none`（Codex CLI 当前无法使用 JSON 输出恢复）。
- **图像被忽略**：设置 `imageArg`（并验证 CLI 支持文件路径）。
