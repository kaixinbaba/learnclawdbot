---
summary: "Использование моделей Amazon Bedrock (Converse API) с OpenClaw"
read_when:
  - Вы хотите использовать модели Amazon Bedrock с OpenClaw
  - Вам нужна настройка учетных данных/региона AWS для вызовов моделей
---
# Amazon Bedrock

OpenClaw может использовать модели **Amazon Bedrock** через провайдера **Bedrock Converse**
с потоковой передачей от pi‑ai. Аутентификация Bedrock использует **цепочку учетных данных AWS SDK по умолчанию**,
а не API-ключ.

## Что поддерживает pi‑ai

- Провайдер: `amazon-bedrock`
- API: `bedrock-converse-stream`
- Аутентификация: учетные данные AWS (переменные окружения, общая конфигурация или роль экземпляра)
- Регион: `AWS_REGION` или `AWS_DEFAULT_REGION` (по умолчанию: `us-east-1`)

## Автоматическое обнаружение моделей

Если обнаружены учетные данные AWS, OpenClaw может автоматически обнаруживать модели Bedrock,
которые поддерживают **потоковую передачу** и **текстовый вывод**. Обнаружение использует
`bedrock:ListFoundationModels` и кэшируется (по умолчанию: 1 час).

Параметры конфигурации находятся в `models.bedrockDiscovery`:

```json5
{
  models: {
    bedrockDiscovery: {
      enabled: true,
      region: "us-east-1",
      providerFilter: ["anthropic", "amazon"],
      refreshInterval: 3600,
      defaultContextWindow: 32000,
      defaultMaxTokens: 4096
    }
  }
}
```

Примечания:
- `enabled` по умолчанию `true`, когда присутствуют учетные данные AWS.
- `region` по умолчанию `AWS_REGION` или `AWS_DEFAULT_REGION`, затем `us-east-1`.
- `providerFilter` соответствует именам провайдеров Bedrock (например, `anthropic`).
- `refreshInterval` в секундах; установите `0`, чтобы отключить кэширование.
- `defaultContextWindow` (по умолчанию: `32000`) и `defaultMaxTokens` (по умолчанию: `4096`)
  используются для обнаруженных моделей (переопределите, если знаете ограничения своей модели).

## Настройка (вручную)

1) Убедитесь, что учетные данные AWS доступны на **хосте gateway**:

```bash
export AWS_ACCESS_KEY_ID="AKIA..."
export AWS_SECRET_ACCESS_KEY="..."
export AWS_REGION="us-east-1"
# Опционально:
export AWS_SESSION_TOKEN="..."
export AWS_PROFILE="your-profile"
# Опционально (API key/bearer token Bedrock):
export AWS_BEARER_TOKEN_BEDROCK="..."
```

2) Добавьте провайдера Bedrock и модель в вашу конфигурацию (не требуется `apiKey`):

```json5
{
  models: {
    providers: {
      "amazon-bedrock": {
        baseUrl: "https://bedrock-runtime.us-east-1.amazonaws.com",
        api: "bedrock-converse-stream",
        auth: "aws-sdk",
        models: [
          {
            id: "anthropic.claude-opus-4-5-20251101-v1:0",
            name: "Claude Opus 4.5 (Bedrock)",
            reasoning: true,
            input: ["text", "image"],
            cost: { input: 0, output: 0, cacheRead: 0, cacheWrite: 0 },
            contextWindow: 200000,
            maxTokens: 8192
          }
        ]
      }
    }
  },
  agents: {
    defaults: {
      model: { primary: "amazon-bedrock/anthropic.claude-opus-4-5-20251101-v1:0" }
    }
  }
}
```

## Роли экземпляров EC2

При запуске OpenClaw на экземпляре EC2 с прикрепленной ролью IAM, AWS SDK
автоматически использует сервис метаданных экземпляра (IMDS) для аутентификации.
Однако обнаружение учетных данных OpenClaw в настоящее время проверяет только переменные окружения,
а не учетные данные IMDS.

**Обходной путь:** Установите `AWS_PROFILE=default`, чтобы сигнализировать, что учетные данные AWS
доступны. Фактическая аутентификация все еще использует роль экземпляра через IMDS.

```bash
# Добавьте в ~/.bashrc или ваш профиль оболочки
export AWS_PROFILE=default
export AWS_REGION=us-east-1
```

**Необходимые разрешения IAM** для роли экземпляра EC2:
- `bedrock:InvokeModel`
- `bedrock:InvokeModelWithResponseStream`
- `bedrock:ListFoundationModels` (для автоматического обнаружения)

Или прикрепите управляемую политику `AmazonBedrockFullAccess`.

**Быстрая настройка:**

```bash
# 1. Создайте роль IAM и профиль экземпляра
aws iam create-role --role-name EC2-Bedrock-Access \
  --assume-role-policy-document '{
    "Version": "2012-10-17",
    "Statement": [{
      "Effect": "Allow",
      "Principal": {"Service": "ec2.amazonaws.com"},
      "Action": "sts:AssumeRole"
    }]
  }'

aws iam attach-role-policy --role-name EC2-Bedrock-Access \
  --policy-arn arn:aws:iam::aws:policy/AmazonBedrockFullAccess

aws iam create-instance-profile --instance-profile-name EC2-Bedrock-Access
aws iam add-role-to-instance-profile \
  --instance-profile-name EC2-Bedrock-Access \
  --role-name EC2-Bedrock-Access

# 2. Прикрепите к вашему экземпляру EC2
aws ec2 associate-iam-instance-profile \
  --instance-id i-xxxxx \
  --iam-instance-profile Name=EC2-Bedrock-Access

# 3. На экземпляре EC2 включите обнаружение
openclaw config set models.bedrockDiscovery.enabled true
openclaw config set models.bedrockDiscovery.region us-east-1

# 4. Установите обходные переменные окружения
echo 'export AWS_PROFILE=default' >> ~/.bashrc
echo 'export AWS_REGION=us-east-1' >> ~/.bashrc
source ~/.bashrc

# 5. Проверьте, что модели обнаружены
openclaw models list
```

## Примечания

- Bedrock требует включенного **доступа к модели** в вашей учетной записи AWS/регионе.
- Автоматическое обнаружение требует разрешения `bedrock:ListFoundationModels`.
- Если вы используете профили, установите `AWS_PROFILE` на хосте gateway.
- OpenClaw определяет источник учетных данных в следующем порядке: `AWS_BEARER_TOKEN_BEDROCK`,
  затем `AWS_ACCESS_KEY_ID` + `AWS_SECRET_ACCESS_KEY`, затем `AWS_PROFILE`, затем
  цепочка AWS SDK по умолчанию.
- Поддержка рассуждений зависит от модели; проверьте карточку модели Bedrock для
  текущих возможностей.
- Если вы предпочитаете управляемый поток ключей, вы также можете разместить прокси,
  совместимый с OpenAI, перед Bedrock и настроить его как провайдера OpenAI.
