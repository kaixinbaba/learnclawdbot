---
summary: "ストリーミング + チャンキング動作（ブロック返信、ドラフトストリーミング、制限）"
read_when:
  - チャンネルでのストリーミングまたはチャンキングの動作を説明する場合
  - ブロックストリーミングまたはチャンネルチャンキング動作を変更する場合
  - 重複/早期ブロック返信またはドラフトストリーミングをデバッグする場合
---
# ストリーミング + チャンキング

OpenClawには2つの独立した「ストリーミング」レイヤーがあります：
- **ブロックストリーミング（チャンネル）：** アシスタントが書き込む際に完成した**ブロック**を送信します。これらは通常のチャンネルメッセージです（トークンのデルタではありません）。
- **トークン風ストリーミング（Telegramのみ）：** 生成中に**ドラフトバブル**を部分テキストで更新します。最終メッセージは最後に送信されます。

今日、外部チャンネルメッセージへの**実際のトークンストリーミング**はありません。Telegramのドラフトストリーミングが唯一の部分ストリーム機能です。

## ブロックストリーミング（チャンネルメッセージ）

ブロックストリーミングは、利用可能になったアシスタント出力を粗いチャンクで送信します。

```
モデル出力
  └─ text_delta/events
       ├─ (blockStreamingBreak=text_end)
       │    └─ チャンカーはバッファが増えるとブロックを発行
       └─ (blockStreamingBreak=message_end)
            └─ チャンカーはmessage_endでフラッシュ
                   └─ チャンネル送信（ブロック返信）
```
凡例：
- `text_delta/events`: モデルストリームイベント（非ストリーミングモデルではまばらな場合があります）。
- `chunker`: 最小/最大境界 + ブレーク設定を適用する`EmbeddedBlockChunker`。
- `channel send`: 実際の送信メッセージ（ブロック返信）。

**制御項目：**
- `agents.defaults.blockStreamingDefault`: `"on"`/`"off"` （デフォルトはoff）。
- チャンネル上書き: `*.blockStreaming` （およびアカウントごとのバリアント）でチャンネルごとに`"on"`/`"off"`を強制。
- `agents.defaults.blockStreamingBreak`: `"text_end"` または `"message_end"`。
- `agents.defaults.blockStreamingChunk`: `{ minChars, maxChars, breakPreference? }`。
- `agents.defaults.blockStreamingCoalesce`: `{ minChars?, maxChars?, idleMs? }` （送信前にストリームされたブロックをマージ）。
- チャンネルハードキャップ: `*.textChunkLimit` （例: `channels.whatsapp.textChunkLimit`）。
- チャンネルチャンクモード: `*.chunkMode` （`length`がデフォルト、`newline`は長さチャンキングの前に空白行（段落境界）で分割）。
- Discord ソフトキャップ: `channels.discord.maxLinesPerMessage` （デフォルト17）は、UIのクリッピングを避けるために高い返信を分割します。

**境界のセマンティクス：**
- `text_end`: チャンカーが発行するとすぐにブロックをストリーム。各`text_end`でフラッシュ。
- `message_end`: アシスタントメッセージが終了するまで待機し、バッファされた出力をフラッシュ。

`message_end`は、バッファされたテキストが`maxChars`を超える場合、チャンカーを使用するため、最後に複数のチャンクを発行できます。

## チャンキングアルゴリズム（下限/上限）

ブロックチャンキングは`EmbeddedBlockChunker`によって実装されています：
- **下限：** バッファが `minChars` 以上になるまで発行しません（強制される場合を除く）。
- **上限：** `maxChars`の前に分割を優先。強制される場合は`maxChars`で分割。
- **ブレーク優先順位：** `paragraph` → `newline` → `sentence` → `whitespace` → ハードブレーク。
- **コードフェンス：** フェンス内では決して分割しません。`maxChars`で強制される場合、Markdownを有効に保つためにフェンスを閉じて再開します。

`maxChars`はチャンネルの`textChunkLimit`にクランプされるため、チャンネルごとのキャップを超えることはできません。

## 結合（ストリームされたブロックのマージ）

ブロックストリーミングが有効な場合、OpenClawは送信前に**連続するブロックチャンクをマージ**できます。これにより、「1行スパム」を減らしながら段階的な出力を提供します。

- 結合は、フラッシュする前に**アイドルギャップ** (`idleMs`) を待ちます。
- バッファは`maxChars`で制限され、超えた場合はフラッシュされます。
- `minChars`は、十分なテキストが蓄積されるまで小さな断片が送信されるのを防ぎます（最終フラッシュは常に残りのテキストを送信します）。
- 結合文字は`blockStreamingChunk.breakPreference`から導出されます（`paragraph` → `\n\n`、`newline` → `\n`、`sentence` → スペース）。
- チャンネル上書きは`*.blockStreamingCoalesce`経由で利用可能です（アカウントごとの設定を含む）。
- デフォルトの結合`minChars`は、上書きされない限り、Signal/Slack/Discordでは1500に引き上げられます。

## ブロック間の人間らしいペーシング

ブロックストリーミングが有効な場合、ブロック返信間（最初のブロックの後）に**ランダム化された一時停止**を追加できます。これにより、複数バブルの応答がより自然に感じられます。

- 設定: `agents.defaults.humanDelay` （エージェントごとに`agents.list[].humanDelay`で上書き）。
- モード: `off` （デフォルト）、`natural` （800–2500ms）、`custom` （`minMs`/`maxMs`）。
- **ブロック返信**にのみ適用され、最終返信やツールサマリーには適用されません。

## 「チャンクをストリームするか、すべてをストリームするか」

これは次のようにマッピングされます：
- **チャンクをストリーム：** `blockStreamingDefault: "on"` + `blockStreamingBreak: "text_end"` （進行中に発行）。Telegram以外のチャンネルも`*.blockStreaming: true`が必要です。
- **最後にすべてをストリーム：** `blockStreamingBreak: "message_end"` （1回フラッシュ、非常に長い場合は複数のチャンク）。
- **ブロックストリーミングなし：** `blockStreamingDefault: "off"` （最終返信のみ）。

**チャンネルの注意：** Telegram以外のチャンネルでは、`*.blockStreaming`が明示的に`true`に設定されていない**限り**、ブロックストリーミングは**オフ**です。Telegramは、ブロック返信なしでドラフトをストリームできます（`channels.telegram.streamMode`）。

設定場所のリマインダー: `blockStreaming*`のデフォルトは、ルート設定ではなく`agents.defaults`の下にあります。

## Telegramドラフトストリーミング（トークン風）

Telegramは、ドラフトストリーミングを持つ唯一のチャンネルです：
- **トピック付きプライベートチャット**でBot API `sendMessageDraft`を使用します。
- `channels.telegram.streamMode: "partial" | "block" | "off"`。
  - `partial`: 最新のストリームテキストでドラフトを更新。
  - `block`: チャンクブロックでドラフトを更新（同じチャンカールール）。
  - `off`: ドラフトストリーミングなし。
- ドラフトチャンク設定（`streamMode: "block"`の場合のみ）: `channels.telegram.draftChunk` （デフォルト: `minChars: 200`、`maxChars: 800`）。
- ドラフトストリーミングはブロックストリーミングとは別です。ブロック返信はデフォルトでオフで、Telegram以外のチャンネルでは`*.blockStreaming: true`によってのみ有効化されます。
- 最終返信は依然として通常のメッセージです。
- `/reasoning stream`は推論をドラフトバブルに書き込みます（Telegramのみ）。

ドラフトストリーミングがアクティブな場合、OpenClawは二重ストリーミングを避けるためにその返信のブロックストリーミングを無効にします。

```
Telegram（プライベート + トピック）
  └─ sendMessageDraft（ドラフトバブル）
       ├─ streamMode=partial → 最新テキストを更新
       └─ streamMode=block   → チャンカーがドラフトを更新
  └─ 最終返信 → 通常のメッセージ
```
凡例：
- `sendMessageDraft`: Telegramドラフトバブル（実際のメッセージではありません）。
- `final reply`: 通常のTelegramメッセージ送信。
