---
summary: "セットアップノート付きのgrammYを介したTelegram Bot API統合"
read_when:
  - TelegramまたはgrammYパスウェイの作業時
---
# grammY統合（Telegram Bot API）

# なぜgrammY
- 組み込みのlong-poll + Webhookヘルパー、ミドルウェア、エラーハンドリング、レートリミッターを備えたTS-firstのBot APIクライアント。
- 手動でfetch + FormDataを組むよりクリーンなメディアヘルパー。すべてのBot APIメソッドをサポート。
- 拡張可能: カスタムfetch経由のProxy（プロキシ）サポート、セッションミドルウェア（オプション）、型安全なコンテキスト。

# 出荷したもの
- **単一クライアントパス:** fetchベースの実装は削除されました。grammYがTelegramクライアント（send + gateway）の唯一の方法となり、grammY throttlerがデフォルトで有効になっています。
- **Gateway:** `monitorTelegramProvider`はgrammY `Bot`を構築し、メンション/許可リストゲーティング、`getFile`/`download`経由のメディアダウンロードを接続し、`sendMessage/sendPhoto/sendVideo/sendAudio/sendDocument`で返信を配信します。`webhookCallback`経由でlong-pollまたはWebhookをサポートします。
- **Proxy:** オプションの`channels.telegram.proxy`は、grammYの`client.baseFetch`を通じて`undici.ProxyAgent`を使用します。
- **Webhookサポート:** `webhook-set.ts`は`setWebhook/deleteWebhook`をラップします。`webhook.ts`はhealth + graceful shutdownでコールバックをホストします。`channels.telegram.webhookUrl`が設定されている場合、GatewayはWebhookモードを有効にします（それ以外の場合はlong-poll）。
- **Sessions:** ダイレクトチャットはエージェントのメインSession（セッション）（`agent:<agentId>:<mainKey>`）に集約されます。グループは`agent:<agentId>:telegram:group:<chatId>`を使用します。返信は同じチャンネルにルーティングされます。
- **設定ノブ:** `channels.telegram.botToken`、`channels.telegram.dmPolicy`、`channels.telegram.groups`（許可リスト + メンションデフォルト）、`channels.telegram.allowFrom`、`channels.telegram.groupAllowFrom`、`channels.telegram.groupPolicy`、`channels.telegram.mediaMaxMb`、`channels.telegram.linkPreview`、`channels.telegram.proxy`、`channels.telegram.webhookSecret`、`channels.telegram.webhookUrl`。
- **ドラフトストリーミング:** オプションの`channels.telegram.streamMode`は、プライベートトピックチャット（Bot API 9.3+）で`sendMessageDraft`を使用します。これはチャンネルブロックストリーミングとは別です。
- **テスト:** grammYモックはDM + グループメンションゲーティングとアウトバウンド送信をカバーします。より多くのメディア/Webhookフィクスチャが歓迎されます。

オープンクエスチョン
- Bot API 429に遭遇した場合のオプションのgrammYプラグイン（throttler）。
- より構造化されたメディアテスト（ステッカー、ボイスノート）を追加。
- Webhookリッスンポートを設定可能にする（現在、Gateway経由で接続されない限り8787に固定）。
