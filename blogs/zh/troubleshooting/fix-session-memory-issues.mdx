---
title: "ä¿®å¤ OpenClaw ä¸­çš„ä¼šè¯å†…å­˜å’Œä¸Šä¸‹æ–‡ç®¡ç†é—®é¢˜"
description: "å­¦ä¹ å¦‚ä½•æ’æŸ¥å’Œä¿®å¤ OpenClaw ä¸­çš„ä¼šè¯å‹ç¼©ã€å†…å­˜ä¸¢å¤±å’Œä¸Šä¸‹æ–‡çª—å£é—®é¢˜ã€‚"
slug: /troubleshooting/fix-session-memory-issues
publishedAt: 2026-02-13
updatedAt: 2026-02-13
status: published
visibility: public
tags: troubleshooting, session, memory, compaction
featuredImageUrl: /images/blog/fix-session-memory-issues.png
---

# ä¿®å¤ OpenClaw ä¸­çš„ä¼šè¯å†…å­˜å’Œä¸Šä¸‹æ–‡ç®¡ç†é—®é¢˜

ä¼šè¯å†…å­˜å’Œä¸Šä¸‹æ–‡ç®¡ç†æ˜¯ OpenClaw æ¶æ„çš„å…³é”®ç»„ä»¶ã€‚å½“å‡ºç°é—®é¢˜æ—¶â€”â€”ä¸Šä¸‹æ–‡çª—å£æº¢å‡ºã€é‡è¦ä¿¡æ¯åœ¨å‹ç¼©è¿‡ç¨‹ä¸­ä¸¢å¤±ï¼Œæˆ–ä¼šè¯æ— é™åˆ¶è†¨èƒ€â€”â€”éƒ½ä¼šä¸¥é‡å½±å“æ‚¨çš„ä»£ç†æ€§èƒ½å’Œå¯é æ€§ã€‚æœ¬æŒ‡å—å°†å¸®åŠ©æ‚¨è¯Šæ–­å’Œä¿®å¤è¿™äº›é—®é¢˜ã€‚

## ç†è§£ OpenClaw çš„ä¼šè¯æ¶æ„

### åŒå±‚æŒä¹…åŒ–ç³»ç»Ÿ

OpenClaw é€šè¿‡ä¸¤ä¸ªä¸åŒçš„å±‚ç»´æŠ¤ä¼šè¯çŠ¶æ€:

1. **ä¼šè¯å­˜å‚¨ (`sessions.json`)**
   - å­˜å‚¨ä¼šè¯å…ƒæ•°æ®çš„é”®å€¼æ˜ å°„
   - ä½ç½®: `~/.openclaw/agents/<agentId>/sessions/sessions.json`
   - è·Ÿè¸ª: ä¼šè¯ IDã€æœ€åæ´»åŠ¨æ—¶é—´ã€å¼€å…³çŠ¶æ€ã€ä»¤ç‰Œè®¡æ•°å™¨ã€å‹ç¼©æ¬¡æ•°
   - å¯ä»¥å®‰å…¨åœ°æ‰‹åŠ¨ç¼–è¾‘

2. **ä¼šè¯è®°å½• (`<sessionId>.jsonl`)**
   - åŒ…å«å®Œæ•´å¯¹è¯æ ‘çš„ä»…è¿½åŠ  JSONL æ–‡ä»¶
   - ä½ç½®: `~/.openclaw/agents/<agentId>/sessions/<sessionId>.jsonl`
   - å­˜å‚¨: æ¶ˆæ¯ã€å·¥å…·è°ƒç”¨ã€å‹ç¼©æ‘˜è¦ã€åˆ†æ”¯ç‚¹
   - ç”¨äºä¸ºæœªæ¥çš„å›åˆé‡å»ºä¸Šä¸‹æ–‡

**å…³é”®åŸåˆ™**: Gateway æ˜¯çœŸå®çš„æ•°æ®æºã€‚åœ¨è¿œç¨‹æ¨¡å¼ä¸‹ï¼Œè¿™äº›æ–‡ä»¶å­˜åœ¨äºè¿œç¨‹ä¸»æœºä¸Šï¼Œè€Œä¸æ˜¯æ‚¨çš„æœ¬åœ°æœºå™¨ã€‚

### ä¼šè¯é”®çš„å·¥ä½œåŸç†

OpenClaw ä½¿ç”¨ `sessionKey` æ¥è·¯ç”±å’Œéš”ç¦»å¯¹è¯:

- **ä¸»èŠå¤©/ç›´æ¥èŠå¤©**: `agent:<agentId>:main` (é»˜è®¤)
- **ç¾¤èŠ**: `agent:<agentId>:<channel>:group:<id>`
- **Discord/Slack æˆ¿é—´**: `agent:<agentId>:<channel>:channel:<id>`
- **å®šæ—¶ä»»åŠ¡**: `cron:<job.id>`
- **Webhook**: `hook:<uuid>`

åœ¨ä»»ä½•èŠå¤©ä¸­ä½¿ç”¨ `/status` å¯æŸ¥çœ‹å½“å‰ä¼šè¯é”®å’Œä¸Šä¸‹æ–‡ä½¿ç”¨æƒ…å†µã€‚

## ç†è§£ä¸Šä¸‹æ–‡çª—å£å’Œå‹ç¼©

### ä»€ä¹ˆæ˜¯å‹ç¼©?

æ¯ä¸ªæ¨¡å‹éƒ½æœ‰ä¸€ä¸ª**ä¸Šä¸‹æ–‡çª—å£**â€”â€”å®ƒåœ¨ä¸€æ¬¡è¯·æ±‚ä¸­å¯ä»¥å¤„ç†çš„æœ€å¤§ä»¤ç‰Œæ•°ã€‚é•¿æ—¶é—´è¿è¡Œçš„å¯¹è¯ä¼šç´¯ç§¯æ¶ˆæ¯å’Œå·¥å…·ç»“æœï¼Œæœ€ç»ˆæ¥è¿‘è¿™ä¸ªé™åˆ¶ã€‚OpenClaw çš„**å‹ç¼©**åŠŸèƒ½å°†è¾ƒæ—§çš„å¯¹è¯å†å²æ€»ç»“ä¸ºç´§å‡‘çš„æ‘˜è¦ï¼Œä»…ä¿æŒæœ€è¿‘çš„æ¶ˆæ¯å®Œæ•´ã€‚

å‹ç¼©æ˜¯**æŒä¹…çš„**: æ‘˜è¦å­˜å‚¨åœ¨ä¼šè¯è®°å½•ä¸­ï¼Œå› æ­¤æœªæ¥çš„è¯·æ±‚ä¼šçœ‹åˆ°:
- å‹ç¼©æ‘˜è¦
- å‹ç¼©ç‚¹ä¹‹åçš„æœ€è¿‘æ¶ˆæ¯

### è‡ªåŠ¨å‹ç¼©ä½•æ—¶è§¦å‘

OpenClaw çš„åµŒå…¥å¼ Pi ä»£ç†åœ¨ä¸¤ç§æƒ…å†µä¸‹è§¦å‘è‡ªåŠ¨å‹ç¼©:

1. **æº¢å‡ºæ¢å¤**: æ¨¡å‹è¿”å›ä¸Šä¸‹æ–‡æº¢å‡ºé”™è¯¯ â†’ å‹ç¼© â†’ é‡è¯•
2. **é˜ˆå€¼ç»´æŠ¤**: æˆåŠŸå›åˆåï¼Œå½“:
   ```
   contextTokens > contextWindow - reserveTokens
   ```

### å‹ç¼© vs. ä¼šè¯ä¿®å‰ª

è¿™æ˜¯ä¸¤ç§ä¸åŒçš„æœºåˆ¶:

| ç‰¹æ€§ | å‹ç¼© | ä¼šè¯ä¿®å‰ª |
|------|------|---------|
| **ä½œç”¨** | æ€»ç»“å¹¶æŒä¹…åŒ–å¯¹è¯å†å² | åœ¨å†…å­˜ä¸­ä¿®å‰ªæ—§å·¥å…·ç»“æœ |
| **æŒä¹…æ€§** | å†™å…¥ JSONL è®°å½• | ä¸´æ—¶çš„ï¼Œä»…é’ˆå¯¹æ¯ä¸ªè¯·æ±‚ |
| **ç›®æ ‡** | æ‰€æœ‰æ¶ˆæ¯ç±»å‹ | ä»…å·¥å…·ç»“æœ |
| **è§¦å‘** | ä¸Šä¸‹æ–‡çª—å£é˜ˆå€¼ | ç¼“å­˜ TTL è¿‡æœŸ |

## å¸¸è§ä¼šè¯å†…å­˜é—®é¢˜

### é—®é¢˜ #1: å‹ç¼©æœŸé—´å‡­è¯ä¸¢å¤±

**ç—‡çŠ¶**: è‡ªåŠ¨å‹ç¼©åï¼Œä»£ç†"å¿˜è®°"äº† API å¯†é’¥ã€SSH å‡­è¯æˆ–å·¥ä½œåŒºçŠ¶æ€ã€‚

**æ ¹æœ¬åŸå› **: ä»…å­˜å‚¨åœ¨æœ€è¿‘æ¶ˆæ¯ä¸­çš„å…³é”®ä¸Šä¸‹æ–‡åœ¨ä»£ç†å°†å…¶å†™å…¥æŒä¹…å­˜å‚¨ä¹‹å‰è¢«æ€»ç»“æ‰äº†ã€‚

**è§£å†³æ–¹æ¡ˆ**: å¯ç”¨å‹ç¼©å‰å†…å­˜åˆ·æ–°ã€‚

å†…å­˜åˆ·æ–°åœ¨å‹ç¼©å‰è¿è¡Œä¸€ä¸ªé™é»˜çš„ä»£ç†å›åˆï¼Œæç¤ºä»£ç†å°†é‡è¦ä¿¡æ¯å†™å…¥ç£ç›˜:

```json5
// ~/.openclaw/openclaw.json
{
  agents: {
    defaults: {
      compaction: {
        reserveTokensFloor: 20000,
        memoryFlush: {
          enabled: true,
          softThresholdTokens: 4000,
          systemPrompt: "ä¼šè¯å³å°†å‹ç¼©ã€‚ç«‹å³å­˜å‚¨æŒä¹…è®°å¿†ã€‚",
          prompt: "å°†ä»»ä½•æŒä¹…ç¬”è®°å†™å…¥ memory/YYYY-MM-DD.mdï¼›å¦‚æœæ²¡æœ‰è¦å­˜å‚¨çš„å†…å®¹ï¼Œè¯·å›å¤ NO_REPLYã€‚"
        }
      }
    }
  }
}
```

**å·¥ä½œåŸç†**:
- è§¦å‘æ—¶æœº: `contextTokens > (contextWindow - reserveTokensFloor - softThresholdTokens)`
- æ¯ä¸ªå‹ç¼©å‘¨æœŸè¿è¡Œä¸€æ¬¡(åœ¨ `sessions.json` ä¸­è·Ÿè¸ª)
- ä½¿ç”¨ `NO_REPLY` çº¦å®šæŠ‘åˆ¶ç”¨æˆ·å¯è§è¾“å‡º
- ä»…åœ¨å·¥ä½œåŒºå¯å†™æ—¶è¿è¡Œ

### é—®é¢˜ #2: å·¥å…·ç»“æœå¯¼è‡´çš„ä¸Šä¸‹æ–‡çª—å£è†¨èƒ€

**ç—‡çŠ¶**: å°½ç®¡ç”¨æˆ·æ¶ˆæ¯å¾ˆå°‘ï¼Œä¼šè¯ä»è¿…é€Ÿæ¥è¿‘ä¸Šä¸‹æ–‡é™åˆ¶ã€‚

**æ ¹æœ¬åŸå› **: å¤§å‹å·¥å…·è¾“å‡º(ä¾‹å¦‚ `exec` æ—¥å¿—ã€æ–‡ä»¶è¯»å–ã€ç½‘é¡µæŠ“å–)åœ¨è®°å½•ä¸­ç´¯ç§¯ã€‚

**è§£å†³æ–¹æ¡ˆ**: å¯ç”¨ç¼“å­˜ TTL ä¼šè¯ä¿®å‰ªã€‚

```json5
{
  agents: {
    defaults: {
      contextPruning: {
        mode: "cache-ttl",
        ttl: "5m",
        keepLastAssistants: 3,
        softTrimRatio: 0.3,
        hardClearRatio: 0.5,
        minPrunableToolChars: 50000,
        softTrim: {
          maxChars: 4000,
          headChars: 1500,
          tailChars: 1500
        },
        hardClear: {
          enabled: true,
          placeholder: "[æ—§å·¥å…·ç»“æœå†…å®¹å·²æ¸…é™¤]"
        }
      }
    }
  }
}
```

**Anthropic ç”¨æˆ·çš„æ™ºèƒ½é»˜è®¤å€¼**:
- OAuth/è®¾ç½®ä»¤ç‰Œé…ç½®æ–‡ä»¶: å¯ç”¨ `cache-ttl`ï¼Œå¿ƒè·³ `1h`
- API å¯†é’¥é…ç½®æ–‡ä»¶: å¯ç”¨ `cache-ttl`ï¼Œå¿ƒè·³ `30m`ï¼Œç¼“å­˜ TTL `1h`

**ä¿®å‰ªå†…å®¹**:
- ä»… `toolResult` æ¶ˆæ¯(ç”¨æˆ·/åŠ©æ‰‹æ¶ˆæ¯ä»ä¸ä¿®æ”¹)
- æœ€å N ä¸ªåŠ©æ‰‹æ¶ˆæ¯ä¹‹å‰çš„å·¥å…·ç»“æœ
- è¶…å¤§ç»“æœä¼šè¢«è½¯ä¿®å‰ª(ä¿ç•™å¤´éƒ¨+å°¾éƒ¨ï¼Œä¸­é—´ç”¨ `...` è¿æ¥)
- éå¸¸æ—§çš„ç»“æœç”¨å ä½ç¬¦æ–‡æœ¬ç¡¬æ¸…é™¤
- å›¾åƒå—å§‹ç»ˆå—ä¿æŠ¤

### é—®é¢˜ #3: è¿‡åº¦å‹ç¼©è§¦å‘

**ç—‡çŠ¶**: `ğŸ§¹ è‡ªåŠ¨å‹ç¼©å®Œæˆ` é¢‘ç¹å‡ºç°ï¼Œå³ä½¿åœ¨çŸ­ä¼šè¯ä¸­ä¹Ÿæ˜¯å¦‚æ­¤ã€‚

**æ ¹æœ¬åŸå› **:
1. æ¨¡å‹ä¸Šä¸‹æ–‡çª—å£å¯¹äºå·¥ä½œè´Ÿè½½æ¥è¯´å¤ªå°
2. `reserveTokens` ç›¸å¯¹äºä¸Šä¸‹æ–‡çª—å£è®¾ç½®å¾—å¤ªé«˜
3. ä¼šè¯å¼€å§‹æ—¶æ³¨å…¥çš„å·¥ä½œåŒºæ–‡ä»¶éå¸¸å¤§

**è¯Šæ–­**:

```bash
# æ£€æŸ¥å½“å‰ä¼šè¯çŠ¶æ€
# åœ¨èŠå¤©ä¸­:
/status

# ä» CLI:
openclaw status

# æ£€æŸ¥ä¸Šä¸‹æ–‡åˆ†è§£
# åœ¨èŠå¤©ä¸­:
/context detail
```

**è§£å†³æ–¹æ¡ˆ**:

1. **å¢åŠ é¢„ç•™ä»¤ç‰Œåº•çº¿**(ç•™å‡ºæ›´å¤šç©ºé—´):
```json5
{
  agents: {
    defaults: {
      compaction: {
        reserveTokensFloor: 25000  // é»˜è®¤: 20000
      }
    }
  }
}
```

2. **å‡å°‘å·¥ä½œåŒºæ–‡ä»¶æ³¨å…¥**(é™åˆ¶å¼•å¯¼æ–‡ä»¶å¤§å°):
```json5
{
  agents: {
    defaults: {
      bootstrapMaxChars: 15000  // é»˜è®¤: 20000
    }
  }
}
```

3. **ç­–ç•¥æ€§åœ°ä½¿ç”¨æ‰‹åŠ¨å‹ç¼©**:
```
/compact å…³æ³¨å†³ç­–å’Œæœªè§£å†³çš„é—®é¢˜
```

### é—®é¢˜ #4: ä¼šè¯éš”ç¦»æ³„æ¼ç§æœ‰ä¸Šä¸‹æ–‡

**ç—‡çŠ¶**: æ¥è‡ªç§èŠçš„ä¸ªäººä¿¡æ¯å‡ºç°åœ¨ç¾¤èŠä¸­ï¼Œæˆ–å¤šä¸ªç”¨æˆ·çœ‹åˆ°å½¼æ­¤çš„ä¸Šä¸‹æ–‡ã€‚

**æ ¹æœ¬åŸå› **: é»˜è®¤çš„ `session.dmScope = "main"` å°†æ‰€æœ‰ç§èŠå…±äº«åˆ°ä¸€ä¸ªä¼šè¯é”®ä¸­ã€‚

**è§£å†³æ–¹æ¡ˆ**: ä¸ºå¤šç”¨æˆ·åœºæ™¯å¯ç”¨å®‰å…¨ç§èŠæ¨¡å¼ã€‚

```json5
{
  session: {
    // æŒ‰æ¸ é“ + å‘é€è€…éš”ç¦»ç§èŠä¸Šä¸‹æ–‡
    dmScope: "per-channel-peer",
    
    // å¯¹äºå¤šè´¦æˆ·æ”¶ä»¶ç®±:
    // dmScope: "per-account-channel-peer",
    
    // å¯é€‰: è·¨æ¸ é“é“¾æ¥åŒä¸€ä¸ªäºº
    identityLinks: {
      alice: ["telegram:123456789", "discord:987654321"]
    }
  }
}
```

**ç§èŠèŒƒå›´é€‰é¡¹**:
- `main` (é»˜è®¤): æ‰€æœ‰ç§èŠå…±äº«ä¸€ä¸ªä¼šè¯â€”â€”éå¸¸é€‚åˆå•ç”¨æˆ·è¿ç»­æ€§
- `per-peer`: æŒ‰å‘é€è€… ID è·¨æ¸ é“éš”ç¦»
- `per-channel-peer`: æŒ‰æ¸ é“ + å‘é€è€…éš”ç¦»(æ¨èç”¨äºå…±äº«æ”¶ä»¶ç®±)
- `per-account-channel-peer`: æŒ‰è´¦æˆ· + æ¸ é“ + å‘é€è€…éš”ç¦»(å¤šè´¦æˆ·)

## æ‰‹åŠ¨å†…å­˜ç®¡ç†æœ€ä½³å®è·µ

### NO_REPLY çº¦å®š

è¿è¡Œé™é»˜ç»´æŠ¤æ“ä½œæ—¶ï¼Œä½¿ç”¨ `NO_REPLY` å‰ç¼€æŠ‘åˆ¶ä¼ é€’:

```
NO_REPLY

[ä»£ç†æ‰§è¡Œå†…å­˜å†™å…¥ã€æ–‡ä»¶æ›´æ–°ç­‰]
```

å½“è¾“å‡ºä»¥ `NO_REPLY` å¼€å¤´æ—¶ï¼ŒOpenClaw ä¼šæŠ‘åˆ¶è‰ç¨¿/è¾“å…¥æŒ‡ç¤ºå™¨ï¼Œé˜²æ­¢åœ¨é™é»˜æ“ä½œæœŸé—´éƒ¨åˆ†æ³„æ¼ã€‚

### å†…å­˜æ–‡ä»¶ç»„ç»‡

OpenClaw ä½¿ç”¨çº¯ Markdown ä½œä¸ºå†…å­˜:

```
~/.openclaw/workspace/
â”œâ”€â”€ MEMORY.md              # é•¿æœŸã€ç²¾é€‰è®°å¿†(ä»…ä¸»ä¼šè¯)
â”œâ”€â”€ memory/
â”‚   â”œâ”€â”€ 2026-02-10.md     # æ¯æ—¥æ—¥å¿—(ä»…è¿½åŠ )
â”‚   â”œâ”€â”€ 2026-02-11.md
â”‚   â””â”€â”€ 2026-02-13.md
â””â”€â”€ AGENTS.md, SOUL.md, USER.md ç­‰
```

**æœ€ä½³å®è·µ**:
- **å†³ç­–å’Œåå¥½** â†’ `MEMORY.md`
- **æ¯æ—¥ä¸Šä¸‹æ–‡å’Œç¬”è®°** â†’ `memory/YYYY-MM-DD.md`
- **æ°¸è¿œä¸è¦ä¾èµ–"å¿ƒç†ç¬”è®°"** â†’ å°†æ‰€æœ‰é‡è¦å†…å®¹å†™å…¥ç£ç›˜
- **MEMORY.md ä»…åœ¨ä¸»ä¼šè¯ä¸­åŠ è½½** â†’ ä»ä¸åœ¨ç¾¤ç»„ä¸Šä¸‹æ–‡ä¸­(å®‰å…¨æ€§)

### å†…å­˜æœç´¢é…ç½®

OpenClaw å¯ä»¥åœ¨å†…å­˜æ–‡ä»¶ä¸Šæ„å»ºå‘é‡ç´¢å¼•ä»¥è¿›è¡Œè¯­ä¹‰æœç´¢:

```json5
{
  agents: {
    defaults: {
      memorySearch: {
        enabled: true,
        provider: "openai",  // æˆ– "gemini"ã€"local"
        model: "text-embedding-3-small",
        
        // æ··åˆæœç´¢ (BM25 + å‘é‡)
        query: {
          hybrid: {
            enabled: true,
            vectorWeight: 0.7,
            textWeight: 0.3,
            candidateMultiplier: 4
          }
        },
        
        // ç´¢å¼•é¢å¤–ç›®å½•
        extraPaths: ["../team-docs", "/srv/shared-notes/overview.md"]
      }
    }
  }
}
```

**æä¾›å•†é€‰é¡¹**:
- `openai`: ä½¿ç”¨ OpenAI åµŒå…¥ API(æ”¯æŒæ‰¹é‡ç´¢å¼•ä»¥èŠ‚çœæˆæœ¬)
- `gemini`: ä½¿ç”¨ Google Gemini åµŒå…¥
- `local`: ä½¿ç”¨ node-llama-cpp ä¸ GGUF æ¨¡å‹(è‡ªåŠ¨ä¸‹è½½åˆ° ~300MB)

**æ··åˆæœç´¢ä¼˜åŠ¿**:
- å‘é‡: è¯­ä¹‰åŒ¹é…("Mac Studio gateway host" â‰ˆ "è¿è¡Œç½‘å…³çš„æœºå™¨")
- BM25: ç²¾ç¡®ä»¤ç‰Œ(IDã€é”™è¯¯ä»£ç ã€ä»£ç ç¬¦å·)
- ç»„åˆ: ä¸¤å…¨å…¶ç¾

## è°ƒè¯•ä»¤ç‰Œæˆæœ¬å’Œä¸Šä¸‹æ–‡ä½¿ç”¨

### åœ¨èŠå¤©ä¸­æŸ¥çœ‹ä»¤ç‰Œä½¿ç”¨

```bash
# æ˜¾ç¤ºå½“å‰ä¼šè¯çŠ¶æ€
/status

# å¯ç”¨æ¯ä¸ªå“åº”çš„ä½¿ç”¨é¡µè„š
/usage tokens     # æ˜¾ç¤ºä»¤ç‰Œè®¡æ•°
/usage full       # æ˜¾ç¤ºä»¤ç‰Œ + ä¼°è®¡æˆæœ¬(ä»… API å¯†é’¥)
/usage cost       # æ˜¾ç¤ºæ¥è‡ªæ—¥å¿—çš„æœ¬åœ°æˆæœ¬æ‘˜è¦

# ç¦ç”¨ä½¿ç”¨é¡µè„š
/usage off

# æŸ¥çœ‹ä¸Šä¸‹æ–‡åˆ†è§£
/context list     # é«˜çº§åˆ†è§£
/context detail   # æ¯ä¸ªæ–‡ä»¶çš„è¯¦ç»†å¤§å°
```

### ç†è§£æˆæœ¬ä¼°ç®—

OpenClaw ä»æ¨¡å‹å®šä»·é…ç½®ä¼°ç®—æˆæœ¬:

```json5
{
  models: {
    providers: {
      anthropic: {
        models: [
          {
            id: "claude-sonnet-4-5",
            cost: {
              input: 3.0,      // æ¯ 1M ä»¤ç‰Œçš„ç¾å…ƒ
              output: 15.0,
              cacheRead: 0.3,
              cacheWrite: 3.75
            }
          }
        ]
      }
    }
  }
}
```

**ä½¿ç”¨ä¿®å‰ªçš„ç¼“å­˜è¡Œä¸º**:
- Anthropic æç¤ºç¼“å­˜ä»…åœ¨ TTL çª—å£å†…åº”ç”¨
- ç¼“å­˜ TTL ä¿®å‰ªåœ¨ç¼“å­˜è¿‡æœŸæ—¶å‡å°‘ç¼“å­˜å†™å…¥æˆæœ¬
- å¿ƒè·³å¯ä»¥ä¿æŒç¼“å­˜æ¸©æš–(å°†é—´éš”è®¾ç½®ä¸ºç•¥ä½äºç¼“å­˜ TTL)

**ç¤ºä¾‹: ä¿æŒ 1h ç¼“å­˜æ¸©æš–**:
```json5
{
  agents: {
    defaults: {
      model: {
        primary: "anthropic/claude-opus-4-5"
      },
      models: {
        "anthropic/claude-opus-4-5": {
          params: {
            cacheRetention: "long"
          }
        }
      },
      heartbeat: {
        every: "55m"  // ç•¥ä½äº 1h ç¼“å­˜ TTL
      }
    }
  }
}
```

## é«˜çº§: ä½¿ç”¨ LanceDB çš„é•¿æœŸå†…å­˜

å¯¹äºå…·æœ‰å¹¿æ³›å†…å­˜éœ€æ±‚çš„ç”Ÿäº§éƒ¨ç½²ï¼ŒOpenClaw æ”¯æŒ LanceDB ä½œä¸ºæ›¿ä»£å†…å­˜åç«¯:

```json5
{
  plugins: {
    slots: {
      memory: "memory-lancedb"  // è€Œä¸æ˜¯é»˜è®¤çš„ "memory-core"
    }
  }
}
```

**LanceDB ä¼˜åŠ¿**:
- é’ˆå¯¹å¤§å‹æ•°æ®é›†ä¼˜åŒ–çš„æŒä¹…å‘é‡å­˜å‚¨
- å¤§è§„æ¨¡æ€§èƒ½æ›´å¥½(æ•°åƒä¸ªå†…å­˜æ¡ç›®)
- è‡ªåŠ¨å¬å›å’Œæ•è·å·¥ä½œæµ
- é«˜çº§è¿‡æ»¤å’Œå…ƒæ•°æ®æŸ¥è¯¢

**å…ˆå†³æ¡ä»¶**:
- å•ç‹¬çš„ LanceDB æœåŠ¡å™¨/å®ä¾‹
- è¿æ¥è¯¦ç»†ä¿¡æ¯çš„é¢å¤–é…ç½®

## é«˜çº§: QMD å†…å­˜åç«¯(å®éªŒæ€§)

QMD åœ¨æœ¬åœ°ä¼˜å…ˆçš„æœç´¢è¾¹è½¦ä¸­ç»“åˆäº† BM25 + å‘é‡ + é‡æ–°æ’åº:

```json5
{
  memory: {
    backend: "qmd",
    qmd: {
      includeDefaultMemory: true,
      update: { interval: "5m", debounceMs: 15000 },
      limits: { maxResults: 6, timeoutMs: 4000 },
      scope: {
        default: "deny",
        rules: [{ action: "allow", match: { chatType: "direct" } }]
      },
      paths: [
        { name: "docs", path: "~/notes", pattern: "**/*.md" }
      ]
    }
  }
}
```

**å…ˆå†³æ¡ä»¶**:
- å®‰è£… QMD CLI: `bun install -g github.com/tobi/qmd`
- æ”¯æŒæ‰©å±•çš„ SQLite: `brew install sqlite` (macOS)
- é¦–æ¬¡æœç´¢è‡ªåŠ¨ä¸‹è½½ GGUF æ¨¡å‹(~300MB)

**QMD åŠŸèƒ½**:
- æœ¬åœ°ä¼˜å…ˆ(æ— å¤–éƒ¨ API)
- æ··åˆæ£€ç´¢(BM25 + å‘é‡ + é‡æ–°æ’åº)
- ä¼šè¯è®°å½•ç´¢å¼•(é€‰æ‹©åŠ å…¥)
- è‡ªå®šä¹‰é›†åˆæ”¯æŒ

## æ•…éšœæ’é™¤æ£€æŸ¥è¡¨

### 1. ä¼šè¯é”®é—®é¢˜

```bash
# æ£€æŸ¥å½“å‰ä¼šè¯é”®
/status

# éªŒè¯ä¼šè¯è·¯ç”±æ˜¯å¦ç¬¦åˆé¢„æœŸ
openclaw sessions --json

# ç¡®è®¤ dmScope é…ç½®
cat ~/.openclaw/openclaw.json | grep -A5 dmScope
```

### 2. ä¸Šä¸‹æ–‡çª—å£é—®é¢˜

```bash
# æŸ¥çœ‹å½“å‰ä¸Šä¸‹æ–‡ä½¿ç”¨æƒ…å†µ
/status

# è¯¦ç»†åˆ†è§£
/context detail

# æ£€æŸ¥æ¨¡å‹ä¸Šä¸‹æ–‡çª—å£
openclaw models list | grep <model-name>

# è§¦å‘æ‰‹åŠ¨å‹ç¼©
/compact åŒ…æ‹¬æœ€è¿‘çš„å†³ç­–å’Œæœªå®Œæˆçš„ä»»åŠ¡
```

### 3. å†…å­˜æœªæŒä¹…åŒ–

```bash
# éªŒè¯å†…å­˜æ–‡ä»¶æ˜¯å¦å­˜åœ¨
ls -la ~/.openclaw/workspace/memory/

# æ£€æŸ¥å†…å­˜åˆ·æ–°é…ç½®
cat ~/.openclaw/openclaw.json | grep -A10 memoryFlush

# éªŒè¯å·¥ä½œåŒºè®¿é—®(åº”è¯¥å¯å†™)
openclaw status | grep workspace
```

### 4. è¿‡é«˜çš„ä»¤ç‰Œæˆæœ¬

```bash
# å¯ç”¨ä¼šè¯ä¿®å‰ª
# ç¼–è¾‘ ~/.openclaw/openclaw.json:
{
  "agents": {
    "defaults": {
      "contextPruning": {
        "mode": "cache-ttl",
        "ttl": "5m"
      }
    }
  }
}

# é‡å¯ç½‘å…³
openclaw gateway restart

# ç›‘æ§æˆæœ¬é™ä½
/usage cost
```

### 5. é™é»˜æ“ä½œæ³„æ¼

ç¡®ä¿æ“ä½œä»¥ç²¾ç¡®çš„ `NO_REPLY` ä»¤ç‰Œå¼€å§‹:

```
NO_REPLY

æ­£åœ¨æ‰§è¡Œå†…å­˜å†™å…¥æ“ä½œ...
```

éœ€è¦ OpenClaw æ„å»º `2026.1.10` æˆ–æ›´é«˜ç‰ˆæœ¬ä»¥è¿›è¡Œæµå¼æŠ‘åˆ¶ã€‚

## ä¼šè¯ç”Ÿå‘½å‘¨æœŸç®¡ç†

### é‡ç½®ç­–ç•¥

æ§åˆ¶ä¼šè¯ä½•æ—¶é‡ç½®:

```json5
{
  session: {
    reset: {
      mode: "daily",      // é€‰é¡¹: "daily"ã€"idle"ã€"off"
      atHour: 4,         // ç½‘å…³ä¸»æœºæœ¬åœ°æ—¶é—´å‡Œæ™¨ 4:00
      idleMinutes: 120   // ç©ºé—² 2 å°æ—¶åä¹Ÿé‡ç½®
    },
    
    // æŒ‰ç±»å‹è¦†ç›–
    resetByType: {
      thread: { mode: "daily", atHour: 4 },
      dm: { mode: "idle", idleMinutes: 240 },
      group: { mode: "idle", idleMinutes: 120 }
    },
    
    // æŒ‰æ¸ é“è¦†ç›–
    resetByChannel: {
      discord: { mode: "idle", idleMinutes: 10080 }  // 1 å‘¨
    }
  }
}
```

**é‡ç½®è§¦å‘å™¨**:
- `/new` æˆ– `/reset` å‘½ä»¤(ç²¾ç¡®åŒ¹é…)
- æ¯æ—¥é‡ç½®è¾¹ç•Œ(é»˜è®¤å‡Œæ™¨ 4:00)
- ç©ºé—²è¶…æ—¶(å½“é…ç½®äº†æ¯æ—¥å’Œç©ºé—²ä¸¤è€…æ—¶ï¼Œå…ˆåˆ°å…ˆå¾—)

### æ‰‹åŠ¨ä¼šè¯ç®¡ç†

```bash
# å¼€å§‹æ–°ä¼šè¯
/new

# ä½¿ç”¨ç‰¹å®šæ¨¡å‹å¼€å§‹æ–°ä¼šè¯
/new opus-4

# å¼ºåˆ¶å‹ç¼©
/compact

# æ£€æŸ¥ä¼šè¯å¥åº·çŠ¶å†µ
/status

# æŸ¥çœ‹æ‰€æœ‰ä¼šè¯
openclaw sessions --json

# æ¸…ç†æ—§ä¼šè¯
# æ‰‹åŠ¨ç¼–è¾‘ sessions.json æˆ–åˆ é™¤ JSONL è®°å½•
```

## é…ç½®å‚è€ƒ

### å®Œæ•´ç¤ºä¾‹

```json5
{
  agents: {
    defaults: {
      workspace: "~/.openclaw/workspace",
      bootstrapMaxChars: 20000,
      
      model: {
        primary: "anthropic/claude-sonnet-4-5"
      },
      
      compaction: {
        reserveTokensFloor: 20000,
        memoryFlush: {
          enabled: true,
          softThresholdTokens: 4000,
          systemPrompt: "ä¼šè¯å³å°†å‹ç¼©ã€‚ç«‹å³å­˜å‚¨æŒä¹…è®°å¿†ã€‚",
          prompt: "å°†ä»»ä½•æŒä¹…ç¬”è®°å†™å…¥ memory/YYYY-MM-DD.mdï¼›å¦‚æœæ²¡æœ‰è¦å­˜å‚¨çš„å†…å®¹ï¼Œè¯·å›å¤ NO_REPLYã€‚"
        }
      },
      
      contextPruning: {
        mode: "cache-ttl",
        ttl: "5m",
        keepLastAssistants: 3,
        softTrimRatio: 0.3,
        hardClearRatio: 0.5
      },
      
      memorySearch: {
        enabled: true,
        provider: "openai",
        model: "text-embedding-3-small",
        query: {
          hybrid: {
            enabled: true,
            vectorWeight: 0.7,
            textWeight: 0.3
          }
        }
      },
      
      heartbeat: {
        every: "55m"
      }
    }
  },
  
  session: {
    dmScope: "per-channel-peer",
    reset: {
      mode: "daily",
      atHour: 4,
      idleMinutes: 120
    },
    resetTriggers: ["/new", "/reset"]
  }
}
```

## ç»“è®º

OpenClaw çš„ä¼šè¯å†…å­˜å’Œä¸Šä¸‹æ–‡ç®¡ç†ç³»ç»ŸåŠŸèƒ½å¼ºå¤§ï¼Œä½†éœ€è¦ç†è§£æ‰èƒ½æœ€ä½³é…ç½®ã€‚å…³é”®è¦ç‚¹:

1. **å¯ç”¨å‹ç¼©å‰å†…å­˜åˆ·æ–°**ä»¥é˜²æ­¢å‡­è¯ä¸¢å¤±
2. **ä½¿ç”¨ç¼“å­˜ TTL ä¼šè¯ä¿®å‰ª**æ¥æ§åˆ¶å·¥å…·ç»“æœè†¨èƒ€
3. **ä¸ºå¤šç”¨æˆ·åœºæ™¯é…ç½®å®‰å…¨ç§èŠæ¨¡å¼**
4. **ä½¿ç”¨ `/usage` å’Œ `/context` å‘½ä»¤ç›‘æ§ä»¤ç‰Œæˆæœ¬**
5. **å°†é‡è¦ä¿¡æ¯å†™å…¥ç£ç›˜**(æ°¸è¿œä¸è¦ä¾èµ–å†…å­˜çŠ¶æ€)
6. **ä¸ºæ‚¨çš„è§„æ¨¡é€‰æ‹©é€‚å½“çš„å†…å­˜åç«¯**(coreã€LanceDB æˆ– QMD)

é€šè¿‡è¿™äº›é…ç½®å’Œæ•…éšœæ’é™¤æŠ€æœ¯ï¼Œæ‚¨å¯ä»¥ç»´æŠ¤å¥åº·çš„ä¼šè¯ï¼Œå…·æœ‰å¯é çš„å†…å­˜æŒä¹…æ€§å’Œæœ€ä½³çš„ä»¤ç‰Œä½¿ç”¨ã€‚

## å»¶ä¼¸é˜…è¯»

- [OpenClaw ä¼šè¯æ–‡æ¡£](https://docs.openclaw.ai/concepts/session)
- [å‹ç¼©æ·±å…¥æ¢è®¨](https://docs.openclaw.ai/concepts/compaction)
- [å†…å­˜æ¶æ„](https://docs.openclaw.ai/concepts/memory)
- [ä»¤ç‰Œä½¿ç”¨å’Œæˆæœ¬](https://docs.openclaw.ai/token-use)
- [ä¼šè¯ä¿®å‰ª](https://docs.openclaw.ai/concepts/session-pruning)
