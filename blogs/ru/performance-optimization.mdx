---
title: Руководство по оптимизации производительности OpenClaw - Устранение замедлений и утечек памяти
description: Полное руководство по выявлению и устранению распространённых проблем производительности в OpenClaw, включая оптимизацию токенов, управление памятью и стратегии обрезки сессий
slug: /performance-optimization
publishedAt: 2026-02-14
status: published
visibility: public
featuredImageUrl: /images/features/performance_optimization.webp
---

# Руководство по оптимизации производительности OpenClaw: Устранение замедлений и утечек памяти

Для стабильной работы OpenClaw в течение нескольких дней или недель необходимо понимать, как система управляет ресурсами. Это руководство охватывает типичные узкие места производительности и практические решения для поддержания быстрой и эффективной работы вашего AI-ассистента.

## Понимание использования токенов и затрат

Каждое взаимодействие с AI-моделью потребляет токены, что напрямую влияет на производительность и стоимость. OpenClaw комплексно отслеживает использование токенов по следующим категориям:

- Системные промпты (инструменты, навыки, файлы рабочего пространства)
- История разговоров
- Вызовы инструментов и их результаты
- Вложения и транскрипты
- Операции кэширования

### Мониторинг потребления токенов

Используйте следующие команды для отслеживания использования в реальном времени:

**Проверка текущего статуса сессии:**
```
/status
```
Показывает вашу модель, использование контекста и ориентировочные затраты.

**Включение футера с использованием для каждого ответа:**
```
/usage full
```
Добавляет подробные метрики токенов после каждого ответа.

**Просмотр сводки по затратам:**
```
/usage cost
```
Показывает накопленные затраты из логов сессии.

### Стратегии оптимизации токенов

**1. Ограничение вывода инструментов**

Большие результаты инструментов (чтение файлов, веб-запросы) потребляют значительное количество токенов. Настройте лимиты вывода:

```json
{
  "tools": {
    "read": {
      "maxChars": 50000
    }
  }
}
```

**2. Использование обрезки сессий**

OpenClaw может автоматически обрезать старые результаты инструментов перед отправкой контекста модели. Включите обрезку по cache-TTL:

```json
{
  "agents": {
    "defaults": {
      "contextPruning": {
        "mode": "cache-ttl",
        "ttl": "5m",
        "keepLastAssistants": 3
      }
    }
  }
}
```

**Как это работает:**
- Сохраняет только последние 3 сообщения ассистента и их результаты инструментов
- Обрезает или очищает более старые выводы инструментов
- Запускается только когда истекает TTL кэша
- Защищает результаты инструментов, содержащие изображения

**3. Использование кэширования промптов**

Для моделей Anthropic кэширование промптов значительно снижает затраты на повторяющийся контекст:

```json
{
  "agents": {
    "defaults": {
      "model": {
        "primary": "anthropic/claude-opus-4-5"
      },
      "models": {
        "anthropic/claude-opus-4-5": {
          "params": {
            "cacheRetention": "long"
          }
        }
      }
    }
  }
}
```

**Советы по оптимизации кэша:**
- TTL кэша обычно составляет 5 минут (Anthropic)
- Используйте heartbeat (`every: "55m"`) для поддержания кэша при TTL 1 час
- Чтение кэша в 10 раз дешевле входных токенов
- Обрезка перед истечением кэша снижает затраты на запись кэша

**4. Сжатие длинных сессий**

Когда разговоры становятся слишком длинными, OpenClaw может суммировать старые сообщения:

```
/compact Сосредоточиться на ключевых решениях и открытых вопросах
```

Автоматическое сжатие срабатывает при приближении к лимитам контекста. Настройте пороговые значения:

```json
{
  "agents": {
    "defaults": {
      "compaction": {
        "autoCompact": true,
        "targetRatio": 0.8,
        "minMessagesBeforeCompact": 10
      }
    }
  }
}
```

## Управление сессиями и памятью

### Лучшие практики жизненного цикла сессий

**Сброс устаревших сессий:**
```
/reset
```
Очищает контекст, сохраняя историю разговоров на диске.

**Начать заново:**
```
/new
```
Создаёт новую сессию с чистого листа.

**Проверка состояния сессии:**
```
/context detail
```
Показывает вклад каждого файла в окно контекста.

### Оптимизация файлов памяти

OpenClaw загружает файлы рабочего пространства (`AGENTS.md`, `SOUL.md`, `TOOLS.md` и т.д.) при каждом запуске сессии. Держите их компактными:

**Ограничение размера файлов начальной загрузки:**
```json
{
  "agents": {
    "defaults": {
      "bootstrapMaxChars": 20000
    }
  }
}
```

**Лучшие практики:**
- Сосредоточьте `AGENTS.md` на правилах рабочего процесса
- Храните подробные справки в отдельных файлах, загружаемых по требованию
- Периодически архивируйте старые файлы `memory/YYYY-MM-DD.md`
- Сжимайте `MEMORY.md`, удаляя устаревший контекст

## Типичные проблемы производительности

### 1. **Неограниченный вывод инструментов**

**Проблема:** Чтение больших лог-файлов или получение целых веб-страниц раздувает контекст.

**Решение:**
```json
{
  "tools": {
    "read": {
      "maxChars": 10000
    },
    "exec": {
      "outputMaxChars": 5000
    }
  }
}
```

### 2. **Забытые heartbeat**

**Проблема:** Проверка heartbeat каждую минуту расходует токены.

**Решение:** Настройте на 30м-1ч в зависимости от потребностей:
```json
{
  "agents": {
    "defaults": {
      "heartbeat": {
        "every": "30m"
      }
    }
  }
}
```

### 3. **Устаревшие записи кэша**

**Проблема:** Сессии простаивают дольше TTL кэша, затем перезаписывают полный промпт при следующем запросе.

**Решение:** Включите обрезку по cache-TTL для сброса окна кэша:
```json
{
  "agents": {
    "defaults": {
      "contextPruning": {
        "mode": "cache-ttl",
        "ttl": "5m"
      }
    }
  }
}
```

### 4. **Вложения изображений в результатах инструментов**

**Проблема:** Изображения потребляют огромное количество токенов.

**Решение:**
- Обрезка сессий пропускает результаты инструментов с изображениями
- Вручную выполните `/reset`, если контекст заполнен
- Используйте `/compact` для суммирования до накопления изображений

### 5. **Перегрузка диагностики**

**Проблема:** Экспорт всей диагностики в OpenTelemetry с высокой частотой выборки.

**Решение:** Используйте выборку и фильтрацию по уровню логов:
```json
{
  "diagnostics": {
    "otel": {
      "sampleRate": 0.1,
      "logs": false
    }
  }
}
```

## Рекомендуемая конфигурация для продакшена

Сбалансированная настройка для стоимости и производительности:

```json
{
  "agents": {
    "defaults": {
      "model": {
        "primary": "anthropic/claude-sonnet-4-5"
      },
      "models": {
        "anthropic/claude-sonnet-4-5": {
          "params": {
            "cacheRetention": "long"
          }
        }
      },
      "contextPruning": {
        "mode": "cache-ttl",
        "ttl": "5m",
        "keepLastAssistants": 3,
        "softTrimRatio": 0.3
      },
      "compaction": {
        "autoCompact": true,
        "targetRatio": 0.8,
        "minMessagesBeforeCompact": 10
      },
      "heartbeat": {
        "every": "30m"
      },
      "bootstrapMaxChars": 20000
    }
  },
  "logging": {
    "level": "info",
    "consoleLevel": "info",
    "redactSensitive": "tools"
  },
  "tools": {
    "read": {
      "maxChars": 50000
    },
    "exec": {
      "outputMaxChars": 10000
    }
  }
}
```

## Чек-лист устранения неполадок

При возникновении замедлений или высоких затрат:

1. **Проверьте использование токенов:** `/status` и `/usage full`
2. **Просмотрите размер контекста:** `/context detail`
3. **Найдите зависшие сессии:** `openclaw status`
4. **Проверьте логи:** `openclaw logs --follow`
5. **Проверьте глубину очереди:** Ищите `openclaw.queue.depth` в метриках
6. **Проверьте поведение кэша:** Ищите частые `cacheWrite` в логах
7. **Аудит вывода инструментов:** Используйте `--raw-stream` для просмотра реальных ответов
8. **Тест со сжатием:** `/compact` и сравните время ответа
9. **Мониторинг затрат:** `/usage cost` для выявления дорогих паттернов
10. **Сброс при необходимости:** `/reset` для устаревших сессий

---

**Совет профессионала:** Регулярно запускайте `openclaw doctor` для раннего выявления проблем конфигурации. Оптимизация производительности — это итеративный процесс: мониторинг, настройка, тестирование!
